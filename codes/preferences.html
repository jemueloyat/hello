<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Preferences / Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <style>
        /* LOADER STYLES (for both login.html and preferences.html) */
        .loader-overlay {
            position: fixed; /* Crucial: Covers the entire viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000; /* Solid black to fully obscure */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Ensure it's on top of everything */
            opacity: 1; /* Starts fully opaque */
            visibility: visible; /* Starts visible */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        /* This is for when the loader needs to disappear */
        .loader-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader {
            position: relative;
            width: 64px;
            height: 64px;
            background-color: rgba(255, 255, 255, 0.5); /* White for contrast against black overlay */
            transform: rotate(45deg);
            overflow: hidden;
        }
        .loader:after{
            content: '';
            position: absolute;
            inset: 8px;
            margin: auto;
            background: #222b32;
        }
        .loader:before{
            content: '';
            position: absolute;
            inset: -15px;
            margin: auto;
            background: #de3500;
            animation: diamondLoader 2s linear infinite;
        }
        @keyframes diamondLoader {
            0% ,10% {
                transform: translate(-64px , -64px) rotate(-45deg)
            }
            90% , 100% {
                transform: translate(0px , 0px) rotate(-45deg)
            }
        }
    </style>
    <div id="loaderOverlay" class="loader-overlay">
        <span class="loader"></span>
    </div>

    <header class="transparent-navbar">
        <div class="logo">
            <img src="assets/logo-removebg-preview.png" alt="Philippine Gaze Logo" class="navbar-logo">
            <span>Philippine Gaze</span>
        </div>
        <nav>
            <a href="index.html">Home</a>
            <a href="main.html">Main</a>
            <a href="stories.html">Stories</a>
            <a href="favorites.html">Favorites</a>
            <a href="preferences.html" class="active">My Dashboard</a>
        </nav>
        <div class="burger-wrapper">
            <div class="burger-menu" id="burgerMenu">&#9776;</div>
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="profile.html">Profile</a>
                <a href="support.html">Customer Service</a>
                <a href="#" id="logoutBtn">Logout</a>
            </div>
        </div>
    </header>

    <main id="preferencesContent" style="display: none;"> <section class="preferences-section">
            <h1>User Dashboard</h1>
            <p>Welcome to your personalized dashboard! Here you can manage your preferences and settings.</p>

            <div class="preference-item">
                <h2>Favorite Travel Types</h2>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="adventureCb"> Adventure</label>
                    <label><input type="checkbox" id="relaxationCb"> Relaxation</label>
                    <label><input type="checkbox" id="culturalCb"> Cultural</label>
                    <label><input type="checkbox" id="foodCb"> Food Exploration</label>
                    <label><input type="checkbox" id="natureCb"> Nature & Wildlife</label>
                </div>
            </div>

            <div class="preference-item">
                <h2>Preferred Regions</h2>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="luzonCb"> Luzon</label>
                    <label><input type="checkbox" id="visayasCb"> Visayas</label>
                    <label><input type="checkbox" id="mindanaoCb"> Mindanao</label>
                </div>
            </div>

            <button id="savePreferencesBtn" class="save-btn">Save Preferences</button>
            <div id="messageArea" class="message-area" style="display: none;"></div>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; 2024 Philippine Gaze. All rights reserved.</p>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDoijFlD_hJ2mp4FstfSZO4qUPKIzEdmPs",
            authDomain: "hello-e7a6d.firebaseapp.com",
            projectId: "hello-e7a6d",
            storageBucket: "hello-e7a6d.appspot.com",
            messagingSenderId: "693146874206",
            appId: "1:693146874206:web:d37f7a3c823fcba4401fcf"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Loader Elements and Functions
        const loaderOverlay = document.getElementById('loaderOverlay');
        const preferencesContent = document.getElementById('preferencesContent');
        const MINIMUM_LOAD_TIME = 1000; // 1 second for content display on destination page

        function activateLoader() {
            loaderOverlay.classList.remove('hidden');
            preferencesContent.style.display = 'none'; // Ensure content is hidden
        }

        function deactivateLoader() {
            loaderOverlay.classList.add('hidden');
            preferencesContent.style.display = 'block'; // Show content after loading
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            const burgerMenu = document.getElementById('burgerMenu');
            const dropdownMenu = document.getElementById('dropdownMenu');

            // --- Firebase Auth State Listener for preferences.html ---
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Loader is already visible by default due to HTML structure
                    // We just need to load data and then deactivate it.
                    await populatePreferences(user.uid);
                    await delay(MINIMUM_LOAD_TIME); // Ensure loader is displayed for min time
                    deactivateLoader(); // Hide loader and show content
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = 'login.html';
                }
            });


            // --- Existing Functionality (retained) ---
            if (burgerMenu) {
                burgerMenu.addEventListener('click', function() {
                    dropdownMenu.classList.toggle('show');
                    burgerMenu.classList.toggle('open');
                });
            }

            document.addEventListener('click', function(event) {
                if (burgerMenu && dropdownMenu && !burgerMenu.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('show');
                    burgerMenu.classList.remove('open');
                }
            });

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function(event) {
                    event.preventDefault();
                    activateLoader(); // Show loader on logout (just in case it was hidden)
                    try {
                        await auth.signOut();
                        await delay(MINIMUM_LOAD_TIME); // Ensure loader is displayed for min time
                        alert('You have been logged out!');
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error("Logout Error:", error);
                        alert("Logout failed: " + error.message);
                        deactivateLoader(); // Hide loader if logout fails
                    }
                });
            }

            const messageArea = document.getElementById('messageArea');
            function showMessage(message, isSuccess = false) {
                messageArea.textContent = message;
                messageArea.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
                messageArea.style.display = 'block';
                setTimeout(() => {
                    messageArea.style.display = 'none';
                }, 3000);
            }

            const adventureCb = document.getElementById('adventureCb');
            const relaxationCb = document.getElementById('relaxationCb');
            const culturalCb = document.getElementById('culturalCb');
            const foodCb = document.getElementById('foodCb');
            const natureCb = document.getElementById('natureCb');

            const luzonCb = document.getElementById('luzonCb');
            const visayasCb = document.getElementById('visayasCb');
            const mindanaoCb = document.getElementById('mindanaoCb');

            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            async function populatePreferences(uid) {
                try {
                    const userDoc = await db.collection("users").doc(uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const preferences = userData.preferences || [];

                        // Populate travel types
                        adventureCb.checked = preferences.includes('adventure');
                        relaxationCb.checked = preferences.includes('relaxation');
                        culturalCb.checked = preferences.includes('cultural');
                        foodCb.checked = preferences.includes('food');
                        natureCb.checked = preferences.includes('nature');

                        // Populate regions
                        luzonCb.checked = preferences.includes('luzon');
                        visayasCb.checked = preferences.includes('visayas');
                        mindanaoCb.checked = preferences.includes('mindanao');
                    }
                } catch (error) {
                    console.error("Error populating preferences:", error);
                    showMessage("Error loading preferences.", false);
                }
            }

            savePreferencesBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    showMessage("You must be logged in to save preferences.", false);
                    return;
                }

                const selectedPreferences = [];
                if (adventureCb.checked) selectedPreferences.push('adventure');
                if (relaxationCb.checked) selectedPreferences.push('relaxation');
                if (culturalCb.checked) selectedPreferences.push('cultural');
                if (foodCb.checked) selectedPreferences.push('food');
                if (natureCb.checked) selectedPreferences.push('nature');

                if (luzonCb.checked) selectedPreferences.push('luzon');
                if (visayasCb.checked) selectedPreferences.push('visayas');
                if (mindanaoCb.checked) selectedPreferences.push('mindanao');

                try {
                    await db.collection("users").doc(user.uid).update({
                        preferences: selectedPreferences
                    });
                    showMessage("Preferences saved successfully!", true);
                } catch (error) {
                    console.error("Error saving preferences:", error);
                    showMessage("Error saving preferences: " + error.message, false);
                }
            });
        });
    </script>
</body>
</html>